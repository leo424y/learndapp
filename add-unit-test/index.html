<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.64">
<title data-react-helmet="true">加入單元測試 | 智能合約(Smart Contract)與分散式網頁應用(DApp)入門</title><meta data-react-helmet="true" name="docsearch:version" content="current,latest"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:title" content="加入單元測試 | 智能合約(Smart Contract)與分散式網頁應用(DApp)入門"><meta data-react-helmet="true" name="description" content="因為智能合約一旦部署就難以修改，因此合約的安全性極其重要，要避免合約中出現一些基礎錯誤，除了透過第三方驗證外，完整地單元測試(unit test)也是必需的。"><meta data-react-helmet="true" property="og:description" content="因為智能合約一旦部署就難以修改，因此合約的安全性極其重要，要避免合約中出現一些基礎錯誤，除了透過第三方驗證外，完整地單元測試(unit test)也是必需的。"><meta data-react-helmet="true" property="og:url" content="http://gasolin.github.io/learndapp/add-unit-test"><link data-react-helmet="true" rel="shortcut icon" href="/learndapp/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="http://gasolin.github.io/learndapp/add-unit-test"><link rel="stylesheet" href="/learndapp/styles.659236df.css">
<link rel="preload" href="/learndapp/styles.4a059bd4.js" as="script">
<link rel="preload" href="/learndapp/runtime~main.9d917034.js" as="script">
<link rel="preload" href="/learndapp/main.fe7756ee.js" as="script">
<link rel="preload" href="/learndapp/2.5a24fa59.js" as="script">
<link rel="preload" href="/learndapp/3.333a94e9.js" as="script">
<link rel="preload" href="/learndapp/4.5f63321f.js" as="script">
<link rel="preload" href="/learndapp/1be78505.facc14d9.js" as="script">
<link rel="preload" href="/learndapp/47.bb337c03.js" as="script">
<link rel="preload" href="/learndapp/935f2afb.911e62a0.js" as="script">
<link rel="preload" href="/learndapp/17896441.ad7a8511.js" as="script">
<link rel="preload" href="/learndapp/9f576039.41bb72c4.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><a class="navbar__brand" href="/learndapp/"><img class="navbar__logo" src="/learndapp/img/logo.svg" alt="My Site Logo"><strong class="navbar__title">智能合約(Smart Contract)與分散式網頁應用(DApp)入門</strong></a></div><div class="navbar__items navbar__items--right"><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2aTZ"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_BsTx">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_BsTx">🌞</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/learndapp/"><img class="navbar__logo" src="/learndapp/img/logo.svg" alt="My Site Logo"><strong class="navbar__title">智能合約(Smart Contract)與分散式網頁應用(DApp)入門</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_2gpo"><div class="docSidebarContainer_3_JD" role="complementary"><div class="sidebar_2urC"><div class="menu menu--responsive menu_5FrY"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_Dm3K" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">簡介</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/learndapp/">Ethereum區塊鏈！智能合約(Smart Contract)與分散式網頁應用(dApp)入門</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/learndapp/CHANGELOG">更新紀錄</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">區塊鏈</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/learndapp/blockchain">區塊鏈基礎</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/learndapp/what-is-blockchain">什麼是區塊鏈？</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/learndapp/what-is-ethereum">什麼是以太坊(Ethereum)</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">智能合約</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/learndapp/smart-contract">智能合約</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/learndapp/what-is-smart-contract">什麼是智能合約(Smart Contract)?</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/learndapp/deploy-smart-contract">如何部署智能合約？</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/learndapp/write-smart-contract-with-solidity">使用solidity語言撰寫智能合約</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/learndapp/create-first-smart-contract-project">建立第一個智能合約專案</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/learndapp/add-new-method-in-smart-contract">為智能合約加入新功能</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/learndapp/create-a-crypto-token">建立第一個加密代幣合約</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/learndapp/create-an-erc20-compatible-token">建立標準代幣</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/learndapp/add-unit-test">加入單元測試</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/learndapp/howto-send-ether-from-wallet">使用MetaMask錢包收送乙太幣</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/learndapp/deploy-to-testnet">將智能合約部署到公開測試網路</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">DApp</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/learndapp/dapp">分散式網頁應用(DApp)</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/learndapp/what-is-dapp">分散式網頁應用(DApp)是什麼</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/learndapp/create-first-dapp">建立第一個DApp</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/learndapp/dapp_with_webpack">使用 Webpack 編譯 DApp</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/learndapp/dapp-with-create-react-app">使用 React 開發 DApp</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3EyW"><div class="container padding-vert--lg docItemWrapper_1EkI"><div class="row"><div class="col docItemCol_2ASc"><div class="docItemContainer_3QWW"><article><header><h1 class="docTitle_1Lrw">加入單元測試</h1></header><div class="markdown"><p>因為智能合約一旦部署就難以修改，因此合約的安全性極其重要，要避免合約中出現一些基礎錯誤，除了透過第三方驗證外，完整地單元測試(unit test)也是必需的。</p><p>目前最成熟的智能合約單元測試方式，還是透過<code>Truffle</code>開發框架來達成。有趣的是Truffle主要使用Javascript來撰寫智能合約的單元測試（也可以用 solidity來寫）。</p><h2 id="加入測試">加入測試</h2><p>接續上一篇建立的<code>HelloToken</code>合約，在<code>test/</code>目錄下加入<code>test_hello_token.js</code>測試檔案（如果覺得這份程式碼不易理解，可跳過這節，後面會介紹更簡潔的測試方法，到時再回來對照著看即可）。</p><pre><code class="language-js">var HelloToken = artifacts.require(&#x27;HelloToken&#x27;);

const INITIAL_SUPPLY = 88888;
let _totalSupply;

contract(&#x27;HelloToken&#x27;, function(accounts) {
  it(&#x27;should met initial supply&#x27;, function() {
    var contract;
    HelloToken.deployed().then((instance) =&gt; {
        contract = instance;
        return contract.totalSupply.call();
    }).then((totalSupply) =&gt; {
        _totalSupply = totalSupply;
        assert.equal(totalSupply.toNumber(), INITIAL_SUPPLY);
        return contract.balanceOf(accounts[0]);
    }).then((senderBalance) =&gt; {
        assert.equal(_totalSupply.toNumber(), senderBalance.toNumber());
    });
  });
});
</code></pre><p>運行<code>truffle test</code>可看到測試通過的結果。</p><pre><code class="language-sh">Contract: HelloToken
    ✓ should met initial supply

1 passing (11ms)
</code></pre><h3 id="講解">講解</h3><pre><code class="language-js">var HelloToken = artifacts.require(&#x27;HelloToken&#x27;);
</code></pre><p><code>artifacts.require</code>的用法和在<code>migrations/</code>中的用法相同，可以直接引入對應的智能合約。</p><pre><code class="language-js">contract(&#x27;HelloToken&#x27;, function(accounts) {
  it(&#x27;should met initial supply&#x27;, function() {
  });
});
</code></pre><p>Truffle是使用Javascript開發中常見的<a href="https://mochajs.org/">Mocha</a>測試框架和<a href="http://chaijs.com/">Chai</a>斷言庫來做單元測試。差別只是把Mocha test中的 <code>describe</code>換成<code>contract</code>。根據官方文件<sup id="fnref-1"><a href="#fn-1" class="footnote-ref">1</a></sup>，<code>contact</code>執行前會自動重新部署到ganache(或測試網路)上，所以智能合約會是剛部署好乾淨的狀態。</p><p>此外，<code>contract</code>也會帶入<code>accounts</code>變數，裡面儲存了ganache或其他你運行的測試網路所提供的帳戶，開發者可以直接使用這些帳戶來測試合約。</p><p>第一個測試是來測部署合約後預設的代幣數目是否正確。</p><pre><code class="language-js">var contract;
HelloToken.deployed().then((instance) =&gt; {
    contract = instance;
    return contract.totalSupply.call();
}).then((totalSupply) =&gt; {
  ...
});
</code></pre><p>這邊內容和在<code>truffle console</code>中輸入的測試內容雷同，使用<code>Promise</code>來確定每個非同步的操作都在上一個操作完成後才繼續執行。</p><p>上一個操作可以透過 <code>return</code> 語句回傳下個操作需要的參數。例如這邊<code>then</code>裡面傳入的<code>totalSupply</code>參數，是來自上一行<code>return contract.totalSupply.call()</code>的結果。</p><pre><code class="language-js">assert.equal(totalSupply.toNumber(), INITIAL_SUPPLY);
...
assert.equal(_totalSupply.toNumber(), senderBalance.toNumber());
</code></pre><p>這邊我們透過<code>assert.equal</code>語句驗證了<code>HelloToken</code>合約中的初始代幣總額與<code>INITIAL_SUPPLY</code>參數的值相符，且與合約部署者(<code>accounts[0]</code>)帳戶中擁有的總額相符。</p><h2 id="使用-asyncawait-簡化測試">使用 async/await 簡化測試</h2><p>要理解這樣的promise chain需要一些練習。但其實上面的測試用例中，我們只想做好最後的兩個assert驗證。有沒有比較直覺的測試方法呢？</p><p>有的！2017下半年，Javascript 語言支援了<code>async/await</code>語句[2]（只要安裝Node 7.6版以上即可使用），可以用更直覺的方式撰寫非同步的程式碼。</p><p>智能合約測試剛好也使用大量的非同步程式碼。在<code>test/</code>目錄下加入<code>test_hello_token_async.js</code>測試檔案。使用<code>async/await</code>語句改寫後的智能合約測試程式碼如下：</p><pre><code class="language-js">var HelloToken = artifacts.require(&#x27;HelloToken&#x27;);

const INITIAL_SUPPLY = 88888;

contract(&#x27;HelloToken Async&#x27;, function(accounts) {
  it(&#x27;should met initial supply&#x27;, async function() {
    let contract = await HelloToken.deployed();
    let totalSupply = await contract.totalSupply.call();
    let senderBalance = await contract.balanceOf(accounts[0]);
    assert.equal(totalSupply.toNumber(), INITIAL_SUPPLY);
    assert.equal(totalSupply.toNumber(), senderBalance.toNumber());
  });
});
</code></pre><p>運行<code>truffle test</code>可看到測試通過的結果。</p><pre><code class="language-sh">  Contract: HelloToken
    ✓ should met initial supply

  Contract: HelloToken Async
    ✓ should met initial supply (67ms)


  2 passing (149ms)
</code></pre><h3 id="講解-1">講解</h3><pre><code class="language-js">it(&#x27;should met initial supply&#x27;, async function() {
});
</code></pre><p>要在程式碼中使用async/await，需要在函式前加入<code>async</code>宣告，這樣解譯器才會解析函式中的<code>await</code>語法。</p><pre><code class="language-js">let contract = await HelloToken.deployed();
let totalSupply = await contract.totalSupply.call();
let senderBalance = await contract.balanceOf(accounts[0]);
</code></pre><p>透過在非同步的操作前加上<code>await</code>宣告，這三行程式會依照順序，等待第一行await語句執行完，取得<code>contract</code>變數後，再依序執行第二行語句。第二行語句執行完，取得<code>totalSupply</code>變數後，再繼續執行第三行語句以取得<code>senderBalance</code>變數。</p><p>後面兩個assert語句則與promise撰寫時完全一樣。這樣改寫後，程式碼的可讀性大大地提昇了！</p><h2 id="加入轉帳測試">加入轉帳測試</h2><p>再透過<code>async/await</code>語句，試著加入轉帳測試：</p><pre><code class="language-js">  it(&#x27;should have right balance after transfer&#x27;, async function() {
    const AMOUNT = 123;
    let contract = await HelloToken.deployed();
    // check init balance
    let account0Balance = await contract.balanceOf(accounts[0]);
    let account1Balance = await contract.balanceOf(accounts[1]);
    assert.equal(account0Balance.toNumber(), INITIAL_SUPPLY);
    assert.equal(account1Balance.toNumber(), 0);
    // check balance after transferred
    await contract.transfer(accounts[1], AMOUNT);
    account0Balance = await contract.balanceOf(accounts[0]);
    account1Balance = await contract.balanceOf(accounts[1]);
    assert.equal(account0Balance.toNumber(), INITIAL_SUPPLY - AMOUNT);
    assert.equal(account1Balance.toNumber(), AMOUNT);
  });
</code></pre><p>運行<code>truffle test</code>可看到測試通過的結果。</p><pre><code>  Contract: HelloToken
    ✓ should met initial supply

  Contract: HelloToken Async
    ✓ should met initial supply (101ms)
    ✓ should have right balance after transfer (276ms)


  3 passing (506ms)
</code></pre><h3 id="講解-2">講解</h3><pre><code class="language-js">let account0Balance = await contract.balanceOf(accounts[0]);
let account1Balance = await contract.balanceOf(accounts[1]);
assert.equal(account0Balance.toNumber(), INITIAL_SUPPLY);
assert.equal(account1Balance.toNumber(), 0);
</code></pre><p>範例的前半部測試<code>帳戶0</code>與<code>帳戶1</code>中的代幣餘額。<code>帳戶0</code>即部署代幣的帳戶，因此擁有所有的<code>HelloToken</code>代幣，而<code>帳戶1</code>中則沒有<code>HelloToken</code>代幣。</p><pre><code class="language-js">await contract.transfer(accounts[1], AMOUNT);
</code></pre><p>接著呼叫合約的<code>transfer</code>方法將一些代幣轉入<code>帳戶1</code>。注意這些都是非同步的操作（送出傳輸命令後，要先等待區塊鏈確認），因此需要使用<code>await</code>語句。</p><pre><code class="language-js">account0Balance = await contract.balanceOf(accounts[0]);
account1Balance = await contract.balanceOf(accounts[1]);
assert.equal(account0Balance.toNumber(), INITIAL_SUPPLY - AMOUNT);
assert.equal(account1Balance.toNumber(), AMOUNT);
</code></pre><p>範例的後半部再次測試<code>帳戶0</code>與<code>帳戶1</code>中的代幣餘額。結果符合轉帳後兩個帳戶的預期代幣數額。</p><h2 id="結語">結語</h2><p><code>async/await</code>語句相當適合拿來寫非同步的程式，這特性太適合用來寫智能合約的測試了。因為<code>async/await</code>這語法太新，所以大部分的參考資料都還在用<code>Promise</code>來撰寫。我建議當你看到相關的智能合約測試時，可以用async/await改寫看看，會有很不一樣的感受。</p><h1 id="參考資料">參考資料</h1><ul><li>[1] Writing Tests in Javascript <a href="http://truffleframework.com/docs/getting_started/javascript-tests">http://truffleframework.com/docs/getting_started/javascript-tests</a></li><li>[2] 6 Reasons Why JavaScript’s Async/Await Blows Promises Away (Tutorial)<a href="https://hackernoon.com/6-reasons-why-javascripts-async-await-blows-promises-away-tutorial-c7ec10518dd9">https://hackernoon.com/6-reasons-why-javascripts-async-await-blows-promises-away-tutorial-c7ec10518dd9</a></li><li>[3] 範例網址 <a href="https://github.com/gasolin/learndapp/tree/master/examples/hello_token_test">https://github.com/gasolin/learndapp/tree/master/examples/hello_token_test</a></li></ul></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/facebook/docusaurus/edit/master/website/docs/add-unit-test.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/learndapp/create-an-erc20-compatible-token"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« 建立標準代幣</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/learndapp/howto-send-ether-from-wallet"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">使用MetaMask錢包收送乙太幣 »</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_3SO_"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#加入測試" class="table-of-contents__link">加入測試</a><ul><li><a href="#講解" class="table-of-contents__link">講解</a></li></ul></li><li><a href="#使用-asyncawait-簡化測試" class="table-of-contents__link">使用 async/await 簡化測試</a><ul><li><a href="#講解-1" class="table-of-contents__link">講解</a></li></ul></li><li><a href="#加入轉帳測試" class="table-of-contents__link">加入轉帳測試</a><ul><li><a href="#講解-2" class="table-of-contents__link">講解</a></li></ul></li><li><a href="#結語" class="table-of-contents__link">結語</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a href="http://blog.gasolin.idv.tw/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Blog</a></li><li class="footer__item"><a href="https://github.com/gasolin/learndapp" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="text--center"><div>Copyright © 2020 gasolin. Built with Docusaurus.</div></div></div></footer></div>
<script src="/learndapp/styles.4a059bd4.js"></script>
<script src="/learndapp/runtime~main.9d917034.js"></script>
<script src="/learndapp/main.fe7756ee.js"></script>
<script src="/learndapp/2.5a24fa59.js"></script>
<script src="/learndapp/3.333a94e9.js"></script>
<script src="/learndapp/4.5f63321f.js"></script>
<script src="/learndapp/1be78505.facc14d9.js"></script>
<script src="/learndapp/47.bb337c03.js"></script>
<script src="/learndapp/935f2afb.911e62a0.js"></script>
<script src="/learndapp/17896441.ad7a8511.js"></script>
<script src="/learndapp/9f576039.41bb72c4.js"></script>
</body>
</html>